#!/usr/bin/env ruby

$KCODE = 'n'

require 'pathname'

if ARGV.length == 0
  puts "Usage: #{File.basename(__FILE__)} <zsh_history> [<zsh_history> ...]"
  exit 1
end

files = ARGV.map do |argv|
  file = Pathname(argv)
  raise unless file.file? && file.readable?
  file
end

commands = []
files.each do |file|
  file.each_line do |line|
    # 1行のコマンドのみ
    if line !~ /\\\\$/ && line =~ /^: (\d+):0;/
      commands << [$1.to_i, $']
    end

    # 複数行対応
    #if line =~ /^: (\d+):0;/
    #  commands << [$1.to_i, $']
    #else
    #  $stderr.puts line
    #  commands.last.last << line
    #end
  end
end

hash_commands = {}
commands.sort_by{|time,| time }.each do |time, command|
  hash_commands[command] = time
end

hash_commands.sort_by{|command,time| time }.each do |command, time|
  puts ": #{time}:0;#{command}"
end
