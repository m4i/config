#!/bin/bash -eu

function main() {
	setup_apt
	setup_homebrew
	setup_xdg_config_home
	setup_dotfiles
	setup_misc
}

function setup_apt {
	if [[ $(uname) = Linux ]]; then
		run sudo apt update
		run sudo apt-get install $(grep -v ^# Aptfile | sort | uniq)
	fi
}

function setup_homebrew {
	if ! type brew >/dev/null; then
		run /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"
	fi
	run brew bundle
	if [[ $(uname) = Darwin ]]; then
		run brew bundle --file Brewfile-mac
	fi
}

function setup_xdg_config_home {
	run mkdir -p ~/.config
	cd config
	for file in $(ls -A); do
		case $file in
			git)
				run ln -snf "$PWD/$file" ~/.config
				;;
		esac
	done
	cd ..
}

function setup_dotfiles {
	cd dotfiles
	for file in $(ls -A); do
		case $file in
			.docker|.irbrc|.tmux.conf|.zshenv)
				link_to_dotfile "$file"
				;;
		esac
	done
	cd ..
}

function setup_misc() {
	# diff-highlight
	#          macOS Homebrew            Ubuntu 20.04
	for git in /usr/local/share/git-core /usr/share/doc/git; do
		if [[ -e $git/contrib/diff-highlight/diff-highlight ]]; then
			run mkdir -p ~/bin
			run cp $git/contrib/diff-highlight/diff-highlight ~/bin
			run chmod +x ~/bin/diff-highlight
		fi
	done

	# vscode
	if [[ -e "$HOME/Library/Application Support/Code/User" ]]; then
		run ln -snf "$PWD/vscode/keybindings.json" "$HOME/Library/Application Support/Code/User"
		run ln -snf "$PWD/vscode/settings.json" "$HOME/Library/Application Support/Code/User"
	fi
}

function link_to_dotfile() {
	local file="$1"

	local target="$PWD/$file"
	local link=~/"$file"

	if [[ -e "$link" ]] && [[ ! -L "$link" ]]; then
		run mv "$link" "$link.$(date +%Y%m%dT%H%M%S)"
	fi
	run ln -snf "$target" "$link"
}

function run() {
	echo "$@"
	"$@"
}

cd $(dirname $0)
main
